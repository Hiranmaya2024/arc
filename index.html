<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pharmaceutical Order System</title>
  <!-- PapaParse library for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    :root {
      --primary: #2e7d32;
      --secondary: #1565c0;
      --danger: #c62828;
      --light-bg: #f5f9fc;
      --border: #b0bec5;
      --disabled-bg: #f5f5f5;
      --disabled-text: #bdbdbd;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 15px;
      background: var(--light-bg);
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 20px auto;
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--primary);
    }

    h1 {
      color: var(--primary);
      margin: 0;
    }

    h2 {
      color: var(--secondary);
      margin-top: 25px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }
    
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }

    .form-group, .search-container {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }

    select, input[type="text"], input[type="number"] {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
      font-size: 1rem;
      box-sizing: border-box;
    }
    
    input:disabled {
        background-color: var(--disabled-bg);
        cursor: not-allowed;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    th, td {
      padding: 12px 10px;
      border: 1px solid var(--border);
      text-align: left;
    }

    th {
      background-color: #e3f2fd;
      font-weight: 600;
    }

    tr:nth-child(even) {
      background-color: #f8fdff;
    }
    
    tr.out-of-stock {
        background-color: var(--disabled-bg);
        color: var(--disabled-text);
    }

    .loading, .no-results {
      text-align: center;
      padding: 20px;
      color: var(--secondary);
    }
    
    .stock-info {
        font-size: 0.85rem;
        color: #555;
    }

    .error-message, .success-message {
      padding: 12px;
      border-radius: 4px;
      margin: 15px 0;
      text-align: center;
    }
    
    .error-message {
      color: var(--danger);
      background: #ffcdd2;
      border: 1px solid var(--danger);
    }
    
    .success-message {
      color: var(--primary);
      background: #c8e6c9;
      border: 1px solid var(--primary);
    }
    
    .action-buttons {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        margin-top: 20px;
    }

    .btn {
      padding: 12px 25px;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s;
      text-align: center;
    }
    .btn-primary { background-color: var(--primary); }
    .btn-primary:hover { background-color: #1b5e20; }
    
    .btn-secondary { background-color: var(--secondary); }
    .btn-secondary:hover { background-color: #0d47a1; }
    
    .btn-danger { background-color: var(--danger); }
    .btn-danger:hover { background-color: #b71c1c; }

    #messageArea { min-height: 20px; }
    
    #orderSummaryContainer tfoot .total-in-words {
        font-weight: bold;
        color: var(--primary);
        font-style: italic;
    }

    .remove-item-btn {
        background: none;
        border: none;
        color: var(--danger);
        cursor: pointer;
        font-size: 1.2rem;
    }

    @media (max-width: 768px) {
      table:not(.summary-table), thead:not(.summary-table thead), tbody, th, td, tr {
        display: block;
      }
      thead tr { display: none; }
      tr { border: 1px solid var(--border); margin-bottom: 10px; }
      td {
        border: none;
        border-bottom: 1px solid #eee;
        position: relative;
        padding-left: 50%;
        text-align: right;
      }
      td:before {
        position: absolute;
        left: 10px;
        width: 45%;
        padding-right: 10px;
        white-space: nowrap;
        content: attr(data-label);
        font-weight: bold;
        text-align: left;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header><h1>Pharmaceutical Order System</h1></header>
    
    <div id="messageArea"></div>

    <div class="form-grid">
        <div class="form-group">
          <label for="customerName">Customer / Shop Name</label>
          <input type="text" id="customerName" placeholder="Enter name here">
        </div>
        <div class="form-group">
          <label for="companySelect">Select Company</label>
          <select id="companySelect" onchange="handleCompanyChange()">
            <option value="">-- Loading Companies --</option>
          </select>
        </div>
    </div>
    
    <div class="search-container">
        <label for="itemSearch">Search Products</label>
        <input type="text" id="itemSearch" oninput="renderProductList()" placeholder="Start typing to search for a product...">
    </div>

    <h2>Product List</h2>
    <div id="itemsTableContainer">
      <table id="itemsTable">
        <thead>
          <tr>
            <th>Item</th>
            <th>Rate (₹)</th>
            <th>Stock</th>
            <th>Quantity</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="4" class="loading">Select a company to view products</td></tr>
        </tbody>
      </table>
    </div>
    
    <div id="orderSummaryContainer"></div>
    
  </div>

  <script>
    // --- Global Variables ---
    let allItems = [];
    let orderCart = []; // Persistent cart for the order
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQr4sjY3X6feIrArFpABeMXbtHTOZb5X-psMFvsAXl2KPivzS8xfE_x-HPVmWcw-TnGgW2EiUVRWEDC/pub?output=csv';
    
    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => loadCSVData());

    function loadCSVData() {
      Papa.parse(CSV_URL, {
        download: true, header: true, skipEmptyLines: true,
        complete: results => {
          if (results.errors.length) console.error("Errors during parsing:", results.errors);
          allItems = results.data.map(row => {
            const normalized = {};
            for (const key in row) {
              if (Object.prototype.hasOwnProperty.call(row, key)) {
                normalized[key.trim().toLowerCase()] = row[key].trim();
              }
            }
            return normalized;
          });
          populateCompanyDropdown();
          renderOrderSummary(); // Initial empty summary
        },
        error: error => {
          console.error('Error loading CSV:', error);
          displayMessage('Failed to load data. Please check the sheet URL or your connection.', 'error');
        }
      });
    }

    function populateCompanyDropdown() {
      const companySelect = document.getElementById('companySelect');
      companySelect.innerHTML = '<option value="">-- Select Company --</option>';
      const companies = [...new Set(allItems.map(row => row.company).filter(Boolean))].sort();
      companies.forEach(company => {
        const option = document.createElement('option');
        option.value = company;
        option.textContent = company;
        companySelect.appendChild(option);
      });
    }

    function handleCompanyChange() {
        document.getElementById('itemSearch').value = ''; // Reset search on company change
        renderProductList();
    }

    function renderProductList() {
      const selectedCompany = document.getElementById('companySelect').value;
      const searchQuery = document.getElementById('itemSearch').value.toLowerCase();
      const tbody = document.querySelector('#itemsTable tbody');
      tbody.innerHTML = '';

      if (!selectedCompany) {
        tbody.innerHTML = '<tr><td colspan="4" class="loading">Select a company to view products</td></tr>';
        return;
      }
      
      let filteredItems = allItems.filter(row => row.company === selectedCompany);
      if(searchQuery) {
          filteredItems = filteredItems.filter(row => row.item.toLowerCase().includes(searchQuery));
      }
      
      if (filteredItems.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="no-results">No products found for this company ${searchQuery ? 'matching your search' : ''}.</td></tr>`;
        return;
      }
      
      filteredItems.forEach(row => {
        const stock = parseInt(row.stock || 0, 10);
        const rate = parseFloat(row.rate || 0);
        const cartItem = orderCart.find(item => item.id === `${row.company}-${row.item}`);
        const currentQty = cartItem ? cartItem.quantity : 0;
        const remainingStock = stock - currentQty;

        const tr = document.createElement('tr');
        if (stock === 0) tr.classList.add('out-of-stock');
        
        tr.innerHTML = `
          <td data-label="Item">${row.item || 'N/A'}</td>
          <td data-label="Rate">₹${rate.toFixed(2)}</td>
          <td data-label="Stock">
            <div>${stock}</div>
            <div class="stock-info">Rem: <span id="rem-stock-${row.company}-${row.item}">${remainingStock}</span></div>
          </td>
          <td data-label="Quantity">
            <input 
              type="number" 
              min="0" 
              max="${stock}" 
              value="${currentQty}" 
              oninput="handleQuantityChange(this, '${row.company}', '${row.item}', ${rate}, ${stock})"
              ${stock === 0 ? 'disabled' : ''}
            >
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function handleQuantityChange(input, company, itemName, rate, stock) {
        let quantity = parseInt(input.value, 10);
        
        // --- Input Validation ---
        if (isNaN(quantity) || quantity < 0) quantity = 0;
        if (quantity > stock) {
            quantity = stock;
            input.value = stock;
        }

        const remainingStockSpan = document.getElementById(`rem-stock-${company}-${itemName}`);
        if(remainingStockSpan) remainingStockSpan.textContent = stock - quantity;

        const itemId = `${company}-${itemName}`;
        const existingItemIndex = orderCart.findIndex(item => item.id === itemId);

        if (quantity > 0) {
            const orderItem = { id: itemId, company, name: itemName, rate, quantity, stock };
            if (existingItemIndex > -1) {
                orderCart[existingItemIndex] = orderItem; // Update quantity
            } else {
                orderCart.push(orderItem); // Add new item
            }
        } else {
            if (existingItemIndex > -1) {
                orderCart.splice(existingItemIndex, 1); // Remove if quantity is 0
            }
        }
        renderOrderSummary();
    }
    
    function removeFromCart(itemId) {
        orderCart = orderCart.filter(item => item.id !== itemId);
        renderProductList(); // Re-render product list to update quantities
        renderOrderSummary(); // Re-render summary
    }

    function renderOrderSummary() {
      const container = document.getElementById('orderSummaryContainer');
      container.innerHTML = '';
      if (orderCart.length === 0) return;

      let grandTotal = 0;
      let summaryHtml = `
        <h2>Order Summary</h2>
        <table class="summary-table">
          <thead><tr><th>Company</th><th>Item</th><th>Qty</th><th>Rate</th><th>Total</th><th>Action</th></tr></thead>
          <tbody>`;

      orderCart.forEach(item => {
        const itemTotal = item.quantity * item.rate;
        grandTotal += itemTotal;
        summaryHtml += `
          <tr>
            <td>${item.company}</td>
            <td>${item.name}</td>
            <td>${item.quantity}</td>
            <td>₹${item.rate.toFixed(2)}</td>
            <td>₹${itemTotal.toFixed(2)}</td>
            <td><button class="remove-item-btn" onclick="removeFromCart('${item.id}')">&times;</button></td>
          </tr>`;
      });
      
      summaryHtml += `
          </tbody>
          <tfoot>
            <tr style="font-weight:bold;">
              <td colspan="4">Grand Total</td>
              <td colspan="2">₹${grandTotal.toFixed(2)}</td>
            </tr>
            <tr>
              <td colspan="6" class="total-in-words">Rupees ${numberToWords(grandTotal)} Only</td>
            </tr>
          </tfoot>
        </table>
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="sendOnWhatsApp()">Send on WhatsApp</button>
            <button class="btn btn-danger" onclick="clearOrder()">Clear Order</button>
        </div>`;

      container.innerHTML = summaryHtml;
    }
    
    function clearOrder() {
        orderCart = [];
        document.getElementById('customerName').value = '';
        document.getElementById('itemSearch').value = '';
        renderProductList();
        renderOrderSummary();
    }

    function sendOnWhatsApp() {
        const customerName = document.getElementById('customerName').value.trim();
        if (!customerName) {
            displayMessage("Please enter a customer or shop name before sending.", 'error');
            return;
        }
        if (orderCart.length === 0) {
            displayMessage("Your cart is empty. Please add items to place an order.", 'error');
            return;
        }

        let message = `*New Order*\n\n*Customer:* ${customerName}\n\n`;
        let grandTotal = 0;

        orderCart.forEach(item => {
            const total = item.quantity * item.rate;
            grandTotal += total;
            message += `*Item:* ${item.name}\n`;
            message += `*Company:* ${item.company}\n`;
            message += `*Qty:* ${item.quantity} x ₹${item.rate.toFixed(2)} = ₹${total.toFixed(2)}\n\n`;
        });
        
        message += `*Grand Total: ₹${grandTotal.toFixed(2)}*\n`;
        message += `(${numberToWords(grandTotal)} Only)`;

        const encodedMessage = encodeURIComponent(message);
        window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
    }

    function numberToWords(num) {
        if (num === 0) return 'Zero';
        const a = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
        const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
        const transform = (n) => {
            let str = '';
            if (n > 99) str += a[Math.floor(n / 100)] + ' Hundred ';
            n %= 100;
            if (n > 19) str += b[Math.floor(n / 10)] + ' ' + a[n % 10];
            else str += a[n];
            return str.trim();
        };
        let result = '';
        if (num > 9999999) { result += transform(Math.floor(num / 10000000)) + ' Crore '; num %= 10000000; }
        if (num > 99999) { result += transform(Math.floor(num / 100000)) + ' Lakh '; num %= 100000; }
        if (num > 999) { result += transform(Math.floor(num / 1000)) + ' Thousand '; num %= 1000; }
        result += transform(num);
        return result.trim().replace(/\s+/g, ' ');
    }

    function displayMessage(message, type = 'error') {
        const messageArea = document.getElementById('messageArea');
        const messageDiv = document.createElement('div');
        messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
        messageDiv.textContent = message;
        messageArea.innerHTML = '';
        messageArea.appendChild(messageDiv);
        setTimeout(() => messageArea.innerHTML = '', 4000);
    }
  </script>
</body>
</html>
