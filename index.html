<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pharmaceutical Order System</title>
  <!-- PapaParse library for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    :root {
      --primary: #2e7d32;
      --secondary: #1565c0;
      --light-bg: #f5f9fc;
      --border: #b0bec5;
      --error-bg: #ffebee;
      --error-text: #d32f2f;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 15px;
      background: var(--light-bg);
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 20px auto;
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--primary);
    }

    h1 {
      color: var(--primary);
      margin: 0;
    }

    h2 {
      color: var(--secondary);
      margin-top: 25px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }

    select, input {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
      font-size: 1rem;
      box-sizing: border-box; /* Ensures padding doesn't affect width */
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    th, td {
      padding: 12px 10px;
      border: 1px solid var(--border);
      text-align: left;
    }

    th {
      background-color: #e3f2fd;
      font-weight: 600;
    }

    tr:nth-child(even) {
      background-color: #f8fdff;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: var(--secondary);
    }

    .error-message {
      color: var(--error-text);
      padding: 10px;
      background: var(--error-bg);
      border: 1px solid var(--error-text);
      border-radius: 4px;
      margin: 15px 0;
      text-align: center;
    }
    
    .action-btn {
      padding: 12px 25px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      margin-top: 15px;
      transition: background-color 0.3s;
    }
    .action-btn:hover {
        background-color: #1b5e20;
    }

    /* Message area for notifications */
    #messageArea {
        min-height: 20px;
        margin-top: 15px;
    }

    /* Responsive table styles */
    @media (max-width: 768px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }
      thead tr {
        position: absolute;
        top: -9999px;
        left: -9999px;
      }
      tr {
        border: 1px solid var(--border);
        margin-bottom: 10px;
      }
      td {
        border: none;
        border-bottom: 1px solid #eee;
        position: relative;
        padding-left: 50%;
        text-align: right;
      }
      td:before {
        position: absolute;
        left: 10px;
        width: 45%;
        padding-right: 10px;
        white-space: nowrap;
        content: attr(data-label);
        font-weight: bold;
        text-align: left;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Pharmaceutical Order System</h1>
    </header>
    
    <!-- Div for displaying messages instead of alerts -->
    <div id="messageArea"></div>

    <div class="form-group">
      <label for="companySelect">Select Company</label>
      <select id="companySelect" onchange="loadItems()">
        <option value="">-- Loading Companies --</option>
      </select>
    </div>

    <h2>Product List</h2>
    <div id="itemsTableContainer">
      <table id="itemsTable">
        <thead>
          <tr>
            <th>Item</th>
            <th>Rate (₹)</th>
            <th>Stock</th>
            <th>Quantity</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="4" class="loading">Select a company to view products</td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <button class="action-btn" onclick="placeOrder()">Place Order</button>

    <!-- Div for displaying the order summary -->
    <div id="orderSummaryContainer"></div>
  </div>

  <script>
    // --- Global Variables ---
    let allItems = [];
    // The public URL of the Google Sheet, published as a CSV file.
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQr4sjY3X6feIrArFpABeMXbtHTOZb5X-psMFvsAXl2KPivzS8xfE_x-HPVmWcw-TnGgW2EiUVRWEDC/pub?output=csv';
    
    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', function() {
      loadCSVData();
    });

    /**
     * @function loadCSVData
     * @description Fetches and parses CSV data from Google Sheets using PapaParse's built-in download feature.
     * This is more reliable than a manual fetch() for cross-origin requests.
     */
    function loadCSVData() {
      Papa.parse(CSV_URL, {
        download: true, // Key change: Instructs PapaParse to handle the download.
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          if (results.errors.length > 0) {
              console.error("Errors during parsing:", results.errors);
              displayMessage('Error parsing some of the data.', 'error');
          }

          // Normalize headers to lowercase for consistent and case-insensitive access (e.g., 'Company' becomes 'company').
          allItems = results.data.map(row => {
            const normalized = {};
            for (const key in row) {
              // Use a robust way to check for property ownership.
              if (Object.prototype.hasOwnProperty.call(row, key)) {
                const normalizedKey = key.trim().toLowerCase();
                normalized[normalizedKey] = row[key];
              }
            }
            return normalized;
          });
          
          populateCompanyDropdown();
        },
        error: function(error) {
          console.error('Error loading CSV:', error);
          const tableBody = document.querySelector('#itemsTable tbody');
          tableBody.innerHTML = `<tr><td colspan="4"><div class="error-message">Failed to load data. Please check the sheet URL or your internet connection.</div></td></tr>`;
        }
      });
    }

    /**
     * @function populateCompanyDropdown
     * @description Populates the company selection dropdown with unique company names from the data.
     */
    function populateCompanyDropdown() {
      const companySelect = document.getElementById('companySelect');
      companySelect.innerHTML = '<option value="">-- Select Company --</option>';
      
      // Extract unique, non-empty company names using a Set for efficiency.
      const companies = [...new Set(allItems.map(row => row.company).filter(Boolean))];
      companies.sort(); // Sort companies alphabetically.
      
      companies.forEach(company => {
        const option = document.createElement('option');
        option.value = company;
        option.textContent = company;
        companySelect.appendChild(option);
      });
    }

    /**
     * @function loadItems
     * @description Displays the products in the table based on the selected company.
     */
    function loadItems() {
      const selectedCompany = document.getElementById('companySelect').value;
      const tbody = document.querySelector('#itemsTable tbody');
      tbody.innerHTML = ''; // Clear previous items
      document.getElementById('orderSummaryContainer').innerHTML = ''; // Clear old summary

      if (!selectedCompany) {
        tbody.innerHTML = '<tr><td colspan="4" class="loading">Select a company to view products</td></tr>';
        return;
      }
      
      const filteredItems = allItems.filter(row => row.company === selectedCompany);
      
      if (filteredItems.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="loading">No products found for this company</td></tr>';
        return;
      }
      
      filteredItems.forEach(row => {
        const tr = document.createElement('tr');
        // Ensure numeric values are parsed correctly, providing fallbacks for missing data.
        const rate = parseFloat(row.rate || 0);
        const stock = parseInt(row.stock || 0, 10);
        
        tr.innerHTML = `
          <td data-label="Item">${row.item || 'N/A'}</td>
          <td data-label="Rate">₹${rate.toFixed(2)}</td>
          <td data-label="Stock">${stock}</td>
          <td data-label="Quantity">
            <input type="number" min="0" max="${stock}" value="0" 
                   data-item="${row.item || 'N/A'}" data-rate="${rate}">
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    /**
     * @function placeOrder
     * @description Gathers selected items and quantities to create and display an order summary.
     */
    function placeOrder() {
      const inputs = document.querySelectorAll('#itemsTable input[type="number"]');
      const selectedItems = Array.from(inputs).filter(input => parseInt(input.value, 10) > 0);
      
      // Clear previous messages and summaries
      clearMessage();
      document.getElementById('orderSummaryContainer').innerHTML = '';

      if (selectedItems.length === 0) {
        displayMessage("Please select at least one item with a quantity greater than 0.", 'error');
        return;
      }
      
      // Create order summary table
      let html = '<h2>Order Summary</h2><table><thead><tr><th>Item</th><th>Qty</th><th>Rate</th><th>Total</th></tr></thead><tbody>';
      let grandTotal = 0;
      
      selectedItems.forEach(input => {
        const item = input.dataset.item;
        const qty = parseInt(input.value, 10);
        const rate = parseFloat(input.dataset.rate);
        const itemTotal = qty * rate;
        grandTotal += itemTotal;
        
        html += `<tr>
          <td>${item}</td>
          <td>${qty}</td>
          <td>₹${rate.toFixed(2)}</td>
          <td>₹${itemTotal.toFixed(2)}</td>
        </tr>`;
      });
      
      html += `</tbody><tfoot><tr style="font-weight:bold;">
        <td colspan="3">Grand Total</td>
        <td>₹${grandTotal.toFixed(2)}</td>
      </tr></tfoot></table>`;
      
      // Display order summary in its container
      document.getElementById('orderSummaryContainer').innerHTML = html;
    }

    /**
     * @function displayMessage
     * @description Shows a message to the user in the message area.
     * @param {string} message - The text to display.
     * @param {string} type - The type of message ('error' or 'success').
     */
    function displayMessage(message, type = 'error') {
        const messageArea = document.getElementById('messageArea');
        const messageDiv = document.createElement('div');
        messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
        messageDiv.textContent = message;
        messageArea.innerHTML = ''; // Clear previous messages
        messageArea.appendChild(messageDiv);
    }

    /**
     * @function clearMessage
     * @description Clears any messages from the message area.
     */
    function clearMessage() {
        document.getElementById('messageArea').innerHTML = '';
    }
  </script>
</body>
</html>
