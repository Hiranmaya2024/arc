<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pharma Order Form</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    table, th, td {
      border: 1px solid black;
      border-collapse: collapse;
    }
    th, td {
      padding: 5px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h2>Select Company</h2>
  <select id="companySelect" onchange="filterItems()">
    <option value="">-- Select Company --</option>
  </select>

  <h2>Items</h2>
  <table id="itemsTable">
    <thead>
      <tr>
        <th>Item</th>
        <th>Rate</th>
        <th>Stock</th>
        <th>Quantity</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button onclick="placeOrder()">Place Order</button>

  <div id="orderSummary" class="hidden">
    <h2>Order Summary</h2>
    <div id="orderDetails"></div>
    <button onclick="sendWhatsAppOrder()">Confirm & Send via WhatsApp</button>
  </div>

  <script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQr4sjY3X6feIrArFpABeMXbtHTOZb5X-psMFvsAXl2KPivzS8xfE_x-HPVmWcw-TnGgW2EiUVRWEDC/pub?output=csv';
    let data = [];

    Papa.parse(sheetUrl, {
      download: true,
      header: false,
      complete: function(results) {
        const raw = results.data;
        if (!raw || raw.length < 2) {
          alert('No data found or wrong format');
          return;
        }

        // Assume headers are: Company, Item, Rate, Stock
        data = raw.slice(1).map(row => ({
          Company: row[0],
          Item: row[1],
          Rate: row[2],
          Stock: row[3]
        }));
        populateCompanies();
      }
    });

    function populateCompanies() {
      const companies = [...new Set(data.map(row => row.Company).filter(Boolean))];
      const companySelect = document.getElementById('companySelect');
      companies.forEach(company => {
        const option = document.createElement('option');
        option.value = company;
        option.textContent = company;
        companySelect.appendChild(option);
      });
    }

    function filterItems() {
      const selectedCompany = document.getElementById('companySelect').value;
      const tableBody = document.querySelector('#itemsTable tbody');
      tableBody.innerHTML = '';
      data.filter(row => row.Company === selectedCompany).forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.Item}</td>
          <td>${row.Rate}</td>
          <td>${row.Stock}</td>
          <td><input type="number" min="0" data-item="${row.Item}" data-rate="${row.Rate}" placeholder="Qty"></td>
        `;
        tableBody.appendChild(tr);
      });
    }

    function placeOrder() {
      const inputs = document.querySelectorAll('input[type="number"]');
      let order = [];
      inputs.forEach(input => {
        const qty = parseInt(input.value);
        if (qty > 0) {
          order.push({
            item: input.dataset.item,
            rate: parseFloat(input.dataset.rate),
            qty,
            total: qty * parseFloat(input.dataset.rate)
          });
        }
      });
      if (order.length === 0) {
        alert('No items selected.');
        return;
      }

      let summary = '<table><tr><th>Item</th><th>Qty</th><th>Rate</th><th>Total</th></tr>';
      let totalCost = 0;
      order.forEach(o => {
        summary += `<tr><td>${o.item}</td><td>${o.qty}</td><td>${o.rate}</td><td>${o.total.toFixed(2)}</td></tr>`;
        totalCost += o.total;
      });
      summary += `<tr><td colspan="3"><strong>Total</strong></td><td><strong>${totalCost.toFixed(2)}</strong></td></tr></table>`;

      document.getElementById('orderDetails').innerHTML = summary;
      document.getElementById('orderSummary').classList.remove('hidden');
    }

    function sendWhatsAppOrder() {
      const orderDetails = document.getElementById('orderDetails').innerText;
      const phone = '919533762508'; // Replace with your WhatsApp number
      const message = encodeURIComponent(`Order Details:\n${orderDetails}`);
      window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
    }
  </script>
</body>
</html>
